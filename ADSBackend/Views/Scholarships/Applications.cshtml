@model Scholarships.Models.ScholarshipViewModels.ApplicationViewModel

<ol class="breadcrumb">
    <li class="breadcrumb-item">
        <a asp-controller="Admin" asp-action="Index">Home</a>
    </li>
    <li class="breadcrumb-item">
        <a asp-controller="Scholarships" asp-action="Manage">Scholarships</a>
    </li>
    <li class="breadcrumb-item active">
        <strong>@Model.Scholarship.Name Applications</strong>
    </li>
</ol>

<h2>@Model.Scholarship.Name</h2>

<div class="tabs-container" style="width: 100%">
    <ul class="nav nav-tabs" role="tablist">
        <li><a class="nav-link active" data-toggle="tab" href="#tab-1">Applications</a></li>
        <li><a class="nav-link" data-toggle="tab" href="#tab-2">Analytics</a></li>
    </ul>
    <div class="tab-content">
        <div role="tabpanel" id="tab-1" class="tab-pane active">
            <div class="panel-body">

                @if (!User.IsInRole("Provider"))
                {
                    <div class="ibox alert alert-warning" style="margin-top: 10px; padding: 20px">
                        <button class="btn btn-primary" onclick="createPackage(true)"><i class="fa fa-cogs"></i> Create Application Package</button>  <div style="float: right">Status: <span id="packageStatus"></span></div>
                    </div>
                }

                <table class="table">
                    <thead>
                        <tr>
                            <th style="width: 40%">
                                Applicant Name
                            </th>
                            <th style="white-space: nowrap;">
                                Student ID
                            </th>
                            <th>
                                Submission Date
                            </th>
                            <th>

                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var app in Model.Applications)
                        {
                            <tr>
                                <td style="vertical-align: middle">
                                    <a asp-controller="Scholarships" asp-action="ApplicationView" asp-route-id="@app.ApplicationId">@app.Profile.LastName, @app.Profile.FirstName</a>
                                    @if (app.ApplicantAwarded)
                                    {
                                        <div class="btn btn-warning btn-circle btn-outline" style="margin-left: 10px" data-toggle="tooltip" data-placement="right" title="Awarded Scholarship"><i class="fa fa-trophy"></i></div>
                                    }

                                    @if (app.ApplicantFavorite)
                                    {
                                        <div class="btn btn-danger btn-circle btn-outline" style="margin-left: 10px" data-toggle="tooltip" data-placement="right" title="Favorite Application"><i class="fa fa-heart"></i></div>
                                    }

                                </td>
                                <td style="vertical-align: middle">
                                    @app.Profile.StudentId
                                </td>
                                <td style="vertical-align: middle">
                                    @app.SubmittedDate
                                </td>
                                <td>
                                    <a class="btn btn-white btn-bitbucket" asp-action="ApplicationView" asp-route-id="@app.ApplicationId"><i class="fa fa-id-card-o"></i> View Application</a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>

            </div>
        </div>
        <div role="tabpanel" id="tab-2" class="tab-pane">
            <div class="panel-body">

                <div class="row">
                    <div class="col-lg-3">
                        <div class="ibox ">
                            <div class="ibox-title">
                                <h5>Applications Pending</h5>
                            </div>
                            <div class="ibox-content">
                                <h1 class="no-margins">@Model.Scholarship.ApplicantPending</h1>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3">
                        <div class="ibox ">
                            <div class="ibox-title">
                                <h5>Applications Completed</h5>
                            </div>
                            <div class="ibox-content">
                                <h1 class="no-margins">@Model.Scholarship.ApplicantCount</h1>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="row">
                    <div class="col-lg-12">
                        <div class="ibox">
                            <div class="ibox-title"><h5>Daily Scholarship Views</h5></div>
                            <div class="ibox-content">
                                <canvas id="dailyViews" width="400" height="100"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-lg-12">
                        <div class="ibox">
                            <div class="ibox-title"><h5>Daily Application Views</h5></div>
                            <div class="ibox-content">
                                <canvas id="dailyApplicationViews" width="400" height="100"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>
</div>

@section Styles {
    <link href="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.min.css" rel="stylesheet" />
}

@section Scripts {

    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.4/Chart.bundle.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.1/moment.min.js"></script>

    <script type="text/javascript">

        function createChart(canvasid, uri, label, borderColor) {

            $.getJSON("/api/analytics?label=" + label + "&uri=" + uri, function (chartData) {

                chartData.data.datasets[0].borderColor = borderColor;

                var ctx = document.getElementById(canvasid).getContext("2d");
                var chart = new Chart(ctx, {
                    type: 'line',
                    data: chartData.data,
                    options: {
                        scales: {
                            yAxes: [{
                                ticks: {
                                    precision: 0
                                }
                            }],
                            xAxes: [
                                {
                                    type: 'time',
                                    time: {
                                        unit: 'day'
                                    }
                                }
                            ]
                        }
                    }
                });

            });
        }

        function createPackage(createNew) {

            $.ajax({
                type: "GET",
                url: "/Scholarships/ApplicationPackageGenerate/@Model.Scholarship.ScholarshipId" +
                    (createNew ? "?trigger=true" : ""),
                dataType: "json"
            }).done(function(response, textStatus, jqXHR) {

                if (response.message !== "Completed") {
                    setTimeout(function() { createPackage(false); }, 2000);
                }
                var msg = response.message;
                if (response.message === "Completed")
                    msg += "<br><a href='/Scholarships/ApplicationPackageDownload/" + response.job.jobId + "'>Download</a>";
                $("#packageStatus").html(msg);

            });
        }

        $.ajax({
            type: "GET",
            url: "/Scholarships/ApplicationPackageGenerate/@Model.Scholarship.ScholarshipId",
            dataType: "json"
        }).done(function(response, textStatus, jqXHR) {
            var msg = response.message;
            if (response.message === "Completed")
                msg += "<br><a href='/Scholarships/ApplicationPackageDownload/" + response.job.jobId + "'>Download</a>";
            $("#packageStatus").html(msg);
        });

        $(function() {

            $('[data-toggle="tooltip"]').tooltip();
        });


        createChart("dailyViews", "Scholarships/Details/@Model.ScholarshipId", "Scholarship Views", "#1b39c2");
        createChart("dailyApplicationViews", "Scholarships/Apply/@Model.ScholarshipId", "Application Views", "#1f8a13");

    </script>

}
